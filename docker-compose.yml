version: '3.6'

services:
  # Main validator
  validator:
    image: hyperledger/sawtooth-validator:1.0
    security_opt:
      - apparmor:unconfined
    ports:
      - 4004:4004
    restart: on-failure
    stop_signal: SIGKILL
    # start the validator with an empty genesis batch
    entrypoint: >-
      bash -c '
      sawadm keygen &&
      sawtooth keygen id_ecdsa &&
      sawset genesis --key /root/.sawtooth/keys/id_ecdsa.priv &&
      sawadm genesis config-genesis.batch &&
      sawtooth-validator -vv
      --endpoint tcp://validator:8800
      --bind component:tcp://eth0:4004
      --bind network:tcp://eth0:8800
      --bind consensus:tcp://eth0:5050
      '

  # Sawtooth REST API that communicates with the validator
  rest-api:
    image: hyperledger/sawtooth-rest-api:1.1
    depends_on:
      - validator
    ports:
      - 8008:8008
    restart: on-failure
    stop_signal: SIGKILL
    entrypoint: >-
      sawtooth-rest-api
      --connect tcp://validator:4004
      --bind rest-api:8008

  # Hyperledger Sawtooth CLI
  shell:
    image: hyperledger/sawtooth-shell:1.1
    depends_on:
      - rest-api
    restart: on-failure
    stop_signal: SIGKILL
    volumes:
      - ./cli.toml:/etc/sawtooth/cli.toml
    entrypoint: >-
      bash -c '
      sawtooth keygen &&
      tail -f /dev/null
      '

  # The web "middleware" service
  middleware:
    ports:
      - 8080:8080
    depends_on:
      - rest-api
    restart: on-failure
    stop_signal: SIGKILL
    command: npm start

  # Static web server for frontend app
  web:
    depends_on:
      - middleware
    restart: on-failure
    stop_signal: SIGKILL

  # Claim transaction processor
  tp-claim:
    depends_on:
      - validator
    restart: on-failure
    stop_signal: SIGKILL
    command: npm run tp-claim:start -- tcp://validator:4004

  # Settings Transaction Processor
  tp-settings:
    image: hyperledger/sawtooth-settings-tp:1.1
    depends_on:
      - validator
    restart: on-failure
    stop_signal: SIGKILL
    entrypoint: >-
      settings-tp
      -vv
      --connect tcp://validator:4004
